<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link rel="stylesheet" href="boomc.css"/>
      <link rel="manifest" href="manifest.json">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
 getAuth,
 onAuthStateChanged,
 createUserWithEmailAndPassword,
 signInWithEmailAndPassword,
 signOut,
 sendPasswordResetEmail,
 GoogleAuthProvider,
 signInWithPopup,
 updateProfile
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
 getFirestore,
 doc,
 getDoc,
 setDoc,
 addDoc,
 collection,
 serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const PROVIDER_DASHBOARD = "PD.html"; // provider (seller) dashboard
const BUYER_DASHBOARD = "BoomShift.html"; // buyer landing page
const ROLE_REQUESTS_COLLECTION = "providerRequests";

const firebaseConfig = {
 apiKey: "AIzaSyC6x73t7-vSO_nJVFWftiUWFP5g2H_fLYo",
 authDomain: "boom-shift.firebaseapp.com",
 projectId: "boom-shift",
 storageBucket: "boom-shift.firebasestorage.app",
 messagingSenderId: "842513407574",
 appId: "1:842513407574:web:1ea8ce74d9ca29c6d165f7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

function showMsg(text, kind = "info") {
 const el = byId("msg") || byId("message") || null;
 if (el) {
 el.textContent = text;
 el.style.color = kind === "err" ? "#ff9b9b" : kind === "warn" ? "#ffd880" : "#bfe7ff";
 el.style.display = "block";
 } else {
 // fallback
 if (kind === "err") console.error(text);
 else console.log(text);
 }
}

function safeRedirect(url) {
 const current = window.location.href.split("/").pop();
 if (!current || current === url || window.location.pathname.endsWith(url)) return;
 window.location.href = url;
}

async function getUserRole(uid) {
 if (!uid) return "buyer";
 try {
 const snap = await getDoc(doc(db, "users", uid));
 if (!snap.exists()) return "buyer";
 return snap.data().role ?? "buyer";
 } catch (err) {
 console.error("getUserRole error:", err);
 return "buyer";
 }
}
async function redirectByRole(user) {
 if (!user) return;
 const role = await getUserRole(user.uid);
 if (role === "seller") safeRedirect(PROVIDER_DASHBOARD);
 else safeRedirect(BUYER_DASHBOARD);
}
async function createOrUpdateUserDoc(user, { displayName = "", requestedRole = "buyer" } = {}) {
 if (!user) throw new Error("No user provided");
 const userRef = doc(db, "users", user.uid);
 const base = {
 username: displayName ?? user.displayName ?? "",
 email: user.email ?? "",
 role: "buyer", // client defaults to buyer; admin must promote
 updatedAt: serverTimestamp()
 };
 await setDoc(userRef, base, { merge: true });

if (requestedRole === "provider") {
 // create a provider request for admins to review
 try {
 await addDoc(collection(db, ROLE_REQUESTS_COLLECTION), {
 userId: user.uid,
 requestedAt: serverTimestamp(),
 status: "pending",
 requestedDisplayName: displayName ?? user.displayName ?? "",
 email: user.email ?? ""
 });
 } catch (err) {
 console.warn("Failed to create provider request:", err);
 }
 }
}
export async function protectProviderPage() {
 onAuthStateChanged(auth, async (user) => {
 if (!user) {
 safeRedirect("BoomAuthecation.html");
 return;
 }
 const role = await getUserRole(user.uid);
 if (role !== "provider") safeRedirect(BUYER_DASHBOARD);
 // else allow page to continue loading
 });
}
async function handleLogin(email, password) {
 if (!email || !password) { showMsg("Enter email and password", "err"); return; }
 try {
 await signInWithEmailAndPassword(auth, email, password);
 // sign-in succeeded; onAuthStateChanged or redirectByRole will handle redirection
 // call redirectByRole immediately for snappy UX
 redirectByRole(auth.currentUser);
 } catch (err) {
 const code = err?.code || "";
 if (code === "auth/user-not-found") showMsg("No account for that email.", "err");
 else if (code === "auth/wrong-password") showMsg("Incorrect password.", "err");
 else if (code === "auth/invalid-email") showMsg("Invalid email address.", "err");
 else showMsg(err?.message || "Sign-in failed.", "err");
 console.error("login error", err);
 }
}
async function handleSignup(email, password, displayName = "", requestedRole = "buyer") {
 if (!email || !password) { showMsg("Provide email and password", "err"); return; }
 try {
 const result = await createUserWithEmailAndPassword(auth, email, password);
 const user = result.user;
 // update displayName in Auth profile for convenience
 try { if (displayName) await updateProfile(user, { displayName }); } catch (uErr) { console.warn("updateProfile failed", uErr); }

// create user doc in Firestore (role set to 'buyer' by default)
await createOrUpdateUserDoc(user, { displayName, requestedRole });

// After signup, redirect according to role (will be buyer by default)
redirectByRole(user);

} catch (err) {
 const code = err?.code || "";
 if (code === "auth/email-already-in-use") showMsg("This email is already in use.", "err");
 else if (code === "auth/invalid-email") showMsg("Invalid email address.", "err");
 else if (code === "auth/weak-password") showMsg("Choose a stronger password.", "err");
 else showMsg(err?.message || "Signup failed", "err");
 console.error("signup error", err);
 }
}


</head>

<body>
      <header>
    <img width="350" height="280" src="boomshift (1).png" alt="BoomShift smile" />
  </header>
<!--<section> -->
 <div class="form-box">
      <div class="form-value">
        <form action="">
          <h2>Login</h2>
          <div class="inputbox">
            <input type="name" required>
            <label for="">Username</label>
          </div>
          <div class="inputbox">
            <input type="password" required>
            <label for="">Password</label>
          </div>
          <div class="forget">
            <label>
              <p>Forget <a href="#">Password</a>
            </label></p>

          </div>
          <button>Log in</button>
          <div class="register">
            <p>Don't have a account <a href="BoomAuthe (1).html">Register</a></p>
          </div>
        </form>
      </div>
    </div>

<script src="devGarage.js"></script>
</body>
</html>